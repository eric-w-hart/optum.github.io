<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Optum Open Source RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Optum Open Source Atom Feed"><title data-react-helmet="true">Copying data between AWS and Azure | Optum Open Source</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://optum.github.io/blog/2021/10/21/s3-to-azure-copy"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Copying data between AWS and Azure | Optum Open Source"><meta data-react-helmet="true" name="description" content="Copying data between AWS and Azure"><meta data-react-helmet="true" property="og:description" content="Copying data between AWS and Azure"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-10-21T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/wrschneider"><meta data-react-helmet="true" property="article:tag" content="AWS Azure S3 Cloud,engineering"><link data-react-helmet="true" rel="icon" href="/img/open_source.svg"><link data-react-helmet="true" rel="canonical" href="https://optum.github.io/blog/2021/10/21/s3-to-azure-copy"><link data-react-helmet="true" rel="alternate" href="https://optum.github.io/blog/2021/10/21/s3-to-azure-copy" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://optum.github.io/blog/2021/10/21/s3-to-azure-copy" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.50574292.css">
<link rel="preload" href="/assets/js/runtime~main.8dcb1336.js" as="script">
<link rel="preload" href="/assets/js/main.2b64b905.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Optum(R)_4C.png" alt="Optum Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/Optum(R)_4C.png" alt="Optum Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Optum Open Source</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Open Source Program Office</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/philosophy">Philosophy</a></li><li><a class="dropdown__link" href="/docs/guilds">Guilds</a></li><li><a class="dropdown__link" href="/docs/givingprogram">Giving Program</a></li><li><a class="dropdown__link" href="/docs/memberships">Memberships</a></li><li><a class="dropdown__link" href="/communities">Our Projects</a></li><li><a class="dropdown__link" href="/contributors">Our Engineers</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a aria-current="page" class="navbar__link" href="/blog">Blog</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/blog/tags/culture">Culture</a></li><li><a class="dropdown__link" href="/blog/tags/engineering">Engineering</a></li><li><a class="dropdown__link" href="/blog/tags/ml-ai">ML/AI</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://www.youtube.com/watch?v=9sdASFlw0As" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Why Contribute to Open Source?<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/Optum" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022/02/08/spark-part2-refactoring">Migrating ETL to Spark - Refactoring</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022/01/25/data-streaming-at-scale-with-benthos">Data Streaming At Scale With Benthos</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022/01/14/spark-series-part-1">Migrating ETL to Spark - Motivation and Quick Start</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2021/11/15/package-model-analytic-reuse">Packaging models and analytics for reuse -  API vs. Inner Source.</a></li><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/blog/2021/10/21/s3-to-azure-copy">Copying data between AWS and Azure</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Copying data between AWS and Azure</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-10-21T00:00:00.000Z" itemprop="datePublished">October 21, 2021</time> Â· <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://github.com/wrschneider" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://github.com/wrschneider.png" alt="Bill Schneider"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/wrschneider" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Bill Schneider</span></a></div><small class="avatar__subtitle" itemprop="description">Sr. Principal Engineer</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_mojV" id="copying-data-between-aws-and-azure">Copying data between AWS and Azure<a class="hash-link" href="#copying-data-between-aws-and-azure" title="Direct link to heading">â€‹</a></h3><p>Many Optum teams are working in Azure, although some are also working in AWS.  So sometimes we have to transfer files between
AWS and Azure, for batch-processing pipelines that have components in both clouds.</p><p>The easiest way to move files between clouds is through their respective object storage APIs: Azure Blob Storage or
AWS S3.  Transfers are over port 443 with public-facing endpoints, and authentication/authorization is handled like
all other native cloud services.</p><p>There are good open-source tools for AWS/Azure file transfers, including
<a href="https://github.com/Azure/azure-storage-azcopy" target="_blank" rel="noopener noreferrer"><code>azcopy</code></a> and
<a href="https://github.com/rclone/rclone" target="_blank" rel="noopener noreferrer"><code>rclone</code></a>.  Both are command-line tools that can be executed from automated
processes.  <code>azcopy</code> is specialized to work with Azure, but lacks the ability to move data from Azure to
AWS S3.  <code>rclone</code> is general purpose any-to-any transfers, but may not be as optimized for uploads to Azure.</p><p>These tools can easily be installed in Docker containers.  If you are running on AWS, you might want to execute
a transfer to/from Azure as a serverless ECS Fargate task.  When you run the task, you would pass the specific
command line parameters in the <code>containerOverrides</code>.  This is all standard; the only tricky piece is
how to manage credentials for both AWS and Azure.  Secrets that can be passed through environment variables can be
<a href="https://docs.aws.amazon.com/AmazonECS/latest/developerguide/specifying-sensitive-data.html" target="_blank" rel="noopener noreferrer">stored in AWS Parameter Store or Secrets Manager and retrieved with <code>secrets</code> in the container definition</a>.  Others require wrapper scripts to perform
additional tasks before running azcopy or rclone.</p><ul><li><p>azcopy </p><ul><li>AWS credentials: for some reason, <a href="https://github.com/Azure/azure-storage-azcopy/issues/1341" target="_blank" rel="noopener noreferrer">azcopy doesn&#x27;t use native AWS profiles</a> and only takes AWS credentials from environment variables.  So you need a wrapper script to set these up.</li><li>Azure SAS tokens: azcopy expects these on the command line, so it&#x27;s a good idea for a wrapper script to append this to the URL</li><li>Azure service principal: secret can be passed through <code>AZCOPY_SPA_CLIENT_SECRET</code> environment variable.</li></ul></li><li><p>Rclone </p><ul><li>AWS credentials: uses the AWS SDK and will pick up AWS credentials from the container&#x27;s execution role.</li><li>Azure SAS tokens: SAS URL can be passed via <code>RCLONE_AZUREBLOB_SAS_URL</code> environment variable as container secret.</li><li>Azure service principal: needs to be stored as JSON in a file.  Your container needs a wrapper script that takes
the actual secret from the injected environment variable, and writes it to a file.</li></ul></li></ul><p>Examples of wrapper script for <code>azcopy</code> to set up AWS credentials from the ECS metadata endpoint:</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">response=$(wget -O - 169.254.170.2$AWS_CONTAINER_CREDENTIALS_RELATIVE_URI)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">export AWS_ACCESS_KEY_ID=$(echo &quot;$response&quot; | jq -r &#x27;.AccessKeyId&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">export AWS_SECRET_ACCESS_KEY=$(echo &quot;$response&quot; | jq -r &#x27;.SecretAccessKey&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">export AWS_SESSION_TOKEN=$(echo &quot;$response&quot; | jq -r &#x27;.Token&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">azcopy $@</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>If you are copying to Azure and need to keep the SAS token secret, you can append modify the above script to
append it to the URL and then omit the SAS token from the Azure blob storage URL passed in <code>containerOverrides</code>:</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">azcopy $@$AZURE_SECRET</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Note that this only works because azcopy can only be used to copy <em>from</em> S3 <em>to</em> Azure, not the other way around, so
we know the Azure URL will always be the final argument on the command line.</p><p>For rclone, this is a wrapper script to handle the service principal JSON:</p><div class="codeBlockContainer_I0IT language-sh theme-code-block"><div class="codeBlockContent_wNvx sh"><pre tabindex="0" class="prism-code language-sh codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain"># assume AZURE_SECRET is configured with secret in container definition</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">echo &quot;$AZURE_SECRET&quot; &gt; /tmp/secret.json</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">export RCLONE_AZUREBLOB_SERVICE_PRINCIPAL_FILE=/tmp/secret.json</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">rclone $@</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>All of the above will allow you to do your Azure/AWS file transfers in a serverless Fargate task, that can be
integrated with whatever other pipeline workflow you have.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/aws-azure-s-3-cloud">AWS Azure S3 Cloud</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/engineering">engineering</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/11/15/package-model-analytic-reuse"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Packaging models and analytics for reuse -  API vs. Inner Source.</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/09/27/kn-kafka-topic-channel"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Knative Channel Sans Kafka Admin Rights</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#copying-data-between-aws-and-azure" class="table-of-contents__link toc-highlight">Copying data between AWS and Azure</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/communities">Our Projects</a></li><li class="footer__item"><a class="footer__link-item" href="/contributors">Our Engineers</a></li></ul></div><div class="col footer__col"><div class="footer__title">Administration</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/optumcoc">Contributor Code of Conduct</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/optumicla">Individual Contributor License Agreement</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/optumlic">Project Licensing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/attribution">Code Attribution</a></li></ul></div><div class="col footer__col"><div class="footer__title">Work With Us</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/Optum" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="mailto:opensource@optum.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>opensource@optum.com<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://careers.unitedhealthgroup.com/search-jobs?kw=&amp;sp=&amp;re=US&amp;jf=20" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Career Opportunities<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items"><li class="footer__item"><a href="https://www.optum.com/terms-of-use.html" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Terms of use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.optum.com/privacy-policy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Optum, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8dcb1336.js"></script>
<script src="/assets/js/main.2b64b905.js"></script>
</body>
</html>