<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.15">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Optum Open Source RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Optum Open Source Atom Feed"><title data-react-helmet="true">Migrating ETL to Spark - Refactoring | Optum Open Source</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://optum.github.io/blog/2022/02/08/spark-part2-refactoring"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Migrating ETL to Spark - Refactoring | Optum Open Source"><meta data-react-helmet="true" name="description" content="_Note: this is the second article in a multi-part series. The first post covered"><meta data-react-helmet="true" property="og:description" content="_Note: this is the second article in a multi-part series. The first post covered"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-02-08T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://www.linkedin.com/in/wrschneider"><meta data-react-helmet="true" property="article:tag" content="Spark,ETL,Engineering"><link data-react-helmet="true" rel="icon" href="/img/open_source.svg"><link data-react-helmet="true" rel="canonical" href="https://optum.github.io/blog/2022/02/08/spark-part2-refactoring"><link data-react-helmet="true" rel="alternate" href="https://optum.github.io/blog/2022/02/08/spark-part2-refactoring" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://optum.github.io/blog/2022/02/08/spark-part2-refactoring" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.50574292.css">
<link rel="preload" href="/assets/js/runtime~main.8dcb1336.js" as="script">
<link rel="preload" href="/assets/js/main.2b64b905.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Optum(R)_4C.png" alt="Optum Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/img/Optum(R)_4C.png" alt="Optum Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Optum Open Source</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" class="navbar__link">Open Source Program Office</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/philosophy">Philosophy</a></li><li><a class="dropdown__link" href="/docs/guilds">Guilds</a></li><li><a class="dropdown__link" href="/docs/givingprogram">Giving Program</a></li><li><a class="dropdown__link" href="/docs/memberships">Memberships</a></li><li><a class="dropdown__link" href="/communities">Our Projects</a></li><li><a class="dropdown__link" href="/contributors">Our Engineers</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a aria-current="page" class="navbar__link" href="/blog">Blog</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/blog/tags/culture">Culture</a></li><li><a class="dropdown__link" href="/blog/tags/engineering">Engineering</a></li><li><a class="dropdown__link" href="/blog/tags/ml-ai">ML/AI</a></li></ul></div></div><div class="navbar__items navbar__items--right"><a href="https://www.youtube.com/watch?v=9sdASFlw0As" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Why Contribute to Open Source?<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/Optum" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_Pssr toggle_TdHA toggleDisabled_jDku"><div class="toggleTrack_SSoT" role="button" tabindex="-1"><div class="toggleTrackCheck_XobZ"><span class="toggleIcon_eZtF">ðŸŒœ</span></div><div class="toggleTrackX_YkSC"><span class="toggleIcon_eZtF">ðŸŒž</span></div><div class="toggleTrackThumb_uRm4"></div></div><input type="checkbox" class="toggleScreenReader_JnkT" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a aria-current="page" class="sidebarItemLink_miNk sidebarItemLinkActive_RRTD" href="/blog/2022/02/08/spark-part2-refactoring">Migrating ETL to Spark - Refactoring</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022/01/25/data-streaming-at-scale-with-benthos">Data Streaming At Scale With Benthos</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2022/01/14/spark-series-part-1">Migrating ETL to Spark - Motivation and Quick Start</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2021/11/15/package-model-analytic-reuse">Packaging models and analytics for reuse -  API vs. Inner Source.</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/blog/2021/10/21/s3-to-azure-copy">Copying data between AWS and Azure</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Migrating ETL to Spark - Refactoring</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-02-08T00:00:00.000Z" itemprop="datePublished">February 8, 2022</time> Â· <!-- -->7 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://www.linkedin.com/in/wrschneider" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_o0gy" src="https://avatars.githubusercontent.com/u/3975157?v=4" alt="Bill Schneider"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://www.linkedin.com/in/wrschneider" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Bill Schneider</span></a></div><small class="avatar__subtitle" itemprop="description">Sr. Principal Engineer</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p><em>Note: this is the second article in a multi-part series. The <a href="https://opensource.optum.com/blog/2022/01/14/spark-series-part-1" target="_blank" rel="noopener noreferrer">first post</a> covered
getting started by copy-pasting SQL into Spark with some rewrites. Future installments will cover topics like performance optimization and validation.</em></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="when-sql-isnt-enough">When SQL isn&#x27;t enough<a class="hash-link" href="#when-sql-isnt-enough" title="Direct link to heading">â€‹</a></h3><p>First, the term &quot;Spark SQL&quot; can be confusing. <a href="https://spark.apache.org/docs/latest/sql-programming-guide.html" target="_blank" rel="noopener noreferrer">&quot;Spark SQL&quot;</a> refers to the structured data processing module within Spark. You can interact with Spark SQL through SQL SELECT queries, and through the DataFrame/Dataset API. For the rest of this article, when I say &quot;SQL&quot; I am referring to SQL syntax.</p><p>At Optum, we often start migrating database-backed processes to Spark by copy-pasting SQL at first, then refactor to use the DataFrame or Dataset API when it makes sense.</p><p>The two main scenarios where it is useful to refactor SQL-based code:</p><ul><li>DRY for transforming query results. You can use the power of Scala and functional programming to apply &quot;for each column&quot; logic.</li><li>Complex business rules that are hard to express in SQL. Spark can distribute computations that go beyond the SQL set operations, and a row in a dataframe can contain nested objects, not just values.</li></ul><h3 class="anchor anchorWithStickyNavbar_mojV" id="stay-dry-with-the-dataframe-api">Stay DRY with the DataFrame API<a class="hash-link" href="#stay-dry-with-the-dataframe-api" title="Direct link to heading">â€‹</a></h3><p>One simple example is, suppose your original SQL query from Oracle or SQL Server selected all the column names as upper-case and you want to ensure that the generated Parquet column names are all lower-case. Rather than trying to parse the SQL text and replace all the column names, you can apply this sort of logic on the DataFrame itself:</p><div class="codeBlockContainer_I0IT language-scala theme-code-block"><div class="codeBlockContent_wNvx scala"><pre tabindex="0" class="prism-code language-scala codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">val result: DataFrame = spark.sql(&quot;SELECT ....&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result.schema.fieldNames.foldLeft(result) { (colName, df) =&gt; df.withColumnRenamed(colName, colName.toLowerCase()) }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>There is an explanation of how <code>foldLeft</code> works on DataFrames <a href="https://stackoverflow.com/a/52028279/836318" target="_blank" rel="noopener noreferrer">on this StackOverflow post</a>. The above code is looping over the column names on the original DataFrame, and for each column, returns a new DataFrame that renames the original column to the lower-case name. The functional syntax abstracts away reassignment of the DataFrame for each column, keeping all variables immutable.</p><p>You can use the DataFrame API to replace SQL syntax altogether, which is especially useful when you have repeating patterns.</p><p>For example if you have a query like this</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx sql"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">SELECT</span><span class="token plain"> cost1 </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> factor_val</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> cost2 </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> factor_val</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> cost3 </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> factor_val</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> costs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">JOIN</span><span class="token plain"> lookup_factor </span><span class="token keyword" style="font-style:italic">on</span><span class="token plain"> costs</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">factor_id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> lookup_factor</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">factor_id</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Where you have a series of identical, numbered columns all multiplied by some factor from a lookup table.</p><p>This can be rewritten as follows:</p><div class="codeBlockContainer_I0IT language-scala theme-code-block"><div class="codeBlockContent_wNvx scala"><pre tabindex="0" class="prism-code language-scala codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">val costColumnRange = (1 to 10)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">val joined = spark.table(&quot;costs&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  .join(spark.table(&quot;lookup_factor&quot;), Seq(&quot;factor_id&quot;))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">val costColumnsMultiplied = costColumnRange.map(i =&gt; col(s&quot;cost$i&quot;) * $&quot;factor&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">val final = joined.select(costColumnsMultiplied)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>Here, we start with a DataFrame that represents the two tables, <code>costs</code> and <code>lookup_factor</code>, joined. No columns are specified at this point, so the <code>joined</code> DataFrame has all columns from the original tables available. This is equivalent to <code>select * from costs join lookup_factor</code>.</p><p>The <code>map</code> transforms the range of column suffixes in <code>costColumnRange</code> to a list of Spark <code>Column</code> objects, where each Column represents a single &quot;costX <!-- -->*<!-- --> factor&quot; column that would appear in a <code>SELECT</code> statmeent.</p><p>The final result is produced by passing the list of <code>Column</code> objects to <code>select</code>.</p><p>This construct is useful for patterns that repeat with similar column names or column names with numeric indexes.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="get-complex-business-logic-out-of-sql">Get complex business logic out of SQL<a class="hash-link" href="#get-complex-business-logic-out-of-sql" title="Direct link to heading">â€‹</a></h3><p>Sometimes complex analytics are calculated in SQL. For example, clinical quality measures typically follow a form like:</p><ul><li>Patient qualifies for inclusion in metric denominator, by looking at procedure codes for an eligible visit in some time range</li><li>Patient is not excluded from the calculation for some reason; for example, if a patient can&#x27;t get a flu shot because of an allergy, that patient is not included counted in the deonominator</li><li>Patient satisfies the metric numerator; for example, the patient got their flu shot.</li></ul><p>In SQL, a typical implementation is building temp tables for each measure. In this approach, each SQL query represents one component calculated for all patients:</p><div class="codeBlockContainer_I0IT language-sql theme-code-block"><div class="codeBlockContent_wNvx sql"><pre tabindex="0" class="prism-code language-sql codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> eligible_patients </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">distinct</span><span class="token plain"> patient_id</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> patient</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">join</span><span class="token plain"> patient_procedure </span><span class="token keyword" style="font-style:italic">using</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">patient_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> procedure_code </span><span class="token operator" style="color:rgb(137, 221, 255)">in</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">codes </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> eligible visit</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">and</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">exists</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> patient_diagnosis</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> patient_diagnosis</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">patient_id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> patient_procedure</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">patient_id</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token operator" style="color:rgb(137, 221, 255)">and</span><span class="token plain"> diagnosis_code </span><span class="token operator" style="color:rgb(137, 221, 255)">in</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">codes that indicate exclusion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> patient_numerators </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">distinct</span><span class="token plain"> patient_id</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> patients</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">join</span><span class="token plain"> procedures </span><span class="token keyword" style="font-style:italic">using</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">patient_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> procedure_code </span><span class="token operator" style="color:rgb(137, 221, 255)">in</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">codes that indicate numerator satisfied</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> measure </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">count</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">numerator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">patient_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">/</span><span class="token function" style="color:rgb(130, 170, 255)">count</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">denominator</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">patient_id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> measure</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> eligible_patients denominator</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">left</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">join</span><span class="token plain"> patient_numerators </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> numerator</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This is workable for one measure, but what happens when you need to calculate dozens of such measures? This kind of logic usually ends up requiring separate scans on tables like <code>patient_diagnosis</code> or <code>patient_procedure</code> for each measure, whether a separate temp table or a separate <code>[not] exists</code> subquery. So each scan ends up calcuating one measure or measure precursor for all patients at once.</p><p>In Spark, you are not limited to SQL set operations. You can treat rows in DataFrames like objects with nested collections (lists or sets), and use any procedural or functional logic on these objects. Then, you can take a completely different approach:</p><ul><li>fetch the all the related records for a patient at once, as a single Patient object</li><li>for each patient, calculate all the measures for the patient in memory.</li></ul><p>The first step in this approach is to retrieve the data into an object graph so it&#x27;s easier to work with:</p><div class="codeBlockContainer_I0IT language-scala theme-code-block"><div class="codeBlockContent_wNvx scala"><pre tabindex="0" class="prism-code language-scala codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">case class Diagnosis(diagnosis_code: String, ...)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">case class Procedure(procedure_code: String, ...)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">case class Patient(patient_id: Long, dx: Seq[Diagnosis], px: Seq[Procedure])</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">val groupedDx = spark.table(&quot;patient_diagnosis&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  .groupBy(&quot;patient_id&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  .agg(collect_list(struct(&quot;diagnosis_code&quot;, ... ).as(&quot;diagnosis_list&quot;)))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">val groupedPx = spark.table(&quot;patient_procedure&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  .groupBy(&quot;patient_id&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  .agg(collect_list(struct(&quot;procedure_code&quot;, ... ).as(&quot;procedure_list&quot;)))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">val patients = spark.table(&quot;patient&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  .join(groupedDx, Seq(&quot;patient_id&quot;))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  .join(groupedPx, Seq(&quot;patient_id&quot;))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  .as[Patient]</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>This code aggregates the records from <code>patient_procedure</code> and <code>patient_diagnosis</code> tables into temporary DataFrames with a single row for each patient. Each row has two fields: <code>patient_id</code>, and an embedded list of procedure or diagnosis codes.</p><p>Since each of these temporary DataFrames only contains one record per patient, they can be joined safely. We could never do a join like this in SQL because a join between <code>patient_procedure</code> and <code>patient_diagnosis</code> would be similar to a cartesian join (more precisely, a cartesian join within single patient, for the procedure and diagnosis codes that match our criteria).</p><p>The final call <code>.as[Patient]</code> turns the Spark DataFrame into a typed Dataset, where each row is a <code>Patient</code> <em>object</em>, defined by the case classes at the beginning. Fields and collections in these objects may then be accessed or iterated, as if they were plain Scala objects.</p><p>This code will take that set of Patients, and call <code>calculateQualityMeasures</code> on each one individually (in parallel, with different partitions of patients on different Spark executors), resulting in a Dataset of <code>QualityMeasure</code> objects:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#bfc7d5"><span class="token plain">case class QualityMeasure(eligible1: Boolean, satisfies1: Boolean, eligible2: Boolean, satisfies2: Boolean, ...)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">def calculateQualityMeasures(p: Patient): QualityMeasure = {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  val eligible1 = !p.px.intersect(ELIGIBLE_VISIT_PX_CODES_1).empty &amp;&amp; p.dx.intersect(EXCLUDE_VISIT_DX_CODES_1).empty</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  val satisfies1 = !p.px.intersect(PX_CODES_1).empty</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  val eligible2 = !p.px.intersect(ELIGIBLE_VISIT_PX_CODES_2).empty &amp;&amp; p.dx.intersect(EXCLUDE_VISIT_DX_CODES_2).empty</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  val satisfies2 = !p.px.intersect(PX_CODES_2).empty</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  QualityMeasure(eligible1, satisfies1, eligible2, satisfies2)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">val results = patients.map(calculateQualityMeasures)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>The <code>map</code> method on the Dataset acts like <code>map</code> on any other Scala collection, where <code>calculateQualityMeasures</code> is a pure function that takes a Patient in and returns QualityMeasures out.</p><p>Note that <code>calculateQualityMeasures</code> has no Spark dependencies and can be unit-tested on Scala case class instances independently!</p><p>Because the Patient object has the full collection of procedure and diagnosis codes in memory, we can perform multiple iterations over the same procedure and diagnosis codes for the patient to calculate all quality measures at the same time. This is a big difference from SQL, where logic operations like <code>where exists</code> are coupled to storage operations to fetch data from disk.</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="coming-up">Coming up<a class="hash-link" href="#coming-up" title="Direct link to heading">â€‹</a></h3><p>The next article will discuss testing and validation strategies.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/spark">Spark</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/etl">ETL</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/engineering">Engineering</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2022/01/25/data-streaming-at-scale-with-benthos"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Data Streaming At Scale With Benthos</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#when-sql-isnt-enough" class="table-of-contents__link toc-highlight">When SQL isn&#39;t enough</a></li><li><a href="#stay-dry-with-the-dataframe-api" class="table-of-contents__link toc-highlight">Stay DRY with the DataFrame API</a></li><li><a href="#get-complex-business-logic-out-of-sql" class="table-of-contents__link toc-highlight">Get complex business logic out of SQL</a></li><li><a href="#coming-up" class="table-of-contents__link toc-highlight">Coming up</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/communities">Our Projects</a></li><li class="footer__item"><a class="footer__link-item" href="/contributors">Our Engineers</a></li></ul></div><div class="col footer__col"><div class="footer__title">Administration</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/optumcoc">Contributor Code of Conduct</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/optumicla">Individual Contributor License Agreement</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/optumlic">Project Licensing</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/attribution">Code Attribution</a></li></ul></div><div class="col footer__col"><div class="footer__title">Work With Us</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/Optum" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="mailto:opensource@optum.com" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>opensource@optum.com<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://careers.unitedhealthgroup.com/search-jobs?kw=&amp;sp=&amp;re=US&amp;jf=20" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Career Opportunities<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items"><li class="footer__item"><a href="https://www.optum.com/terms-of-use.html" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Terms of use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.optum.com/privacy-policy.html" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 Optum, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.8dcb1336.js"></script>
<script src="/assets/js/main.2b64b905.js"></script>
</body>
</html>